name: CI

on:
  pull_request:
    branches: [main]
    paths:
      - "v2/**"
      - "tests/**"
      - "pyproject.toml"
      - "uv.lock"
      - "firestore.rules"
      - "firebase.json"
      - ".github/workflows/ci.yml"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Ruff lint
        run: uv run ruff check v2/

      - name: Ruff format check
        run: uv run ruff format --check v2/

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run tests
        run: >
          uv run pytest
          tests/unit/
          tests/integration/
          -m "not manual"
          --cov=v2
          --cov-report=term-missing

  e2e:
    runs-on: ubuntu-latest
    env:
      FIRESTORE_EMULATOR_HOST: localhost:8080
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --extra dev

      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: "cloud-firestore-emulator"

      - name: Start Firestore Emulator
        run: |
          gcloud emulators firestore start --host-port=0.0.0.0:8080 &
          # エミュレーターの起動を待機（最大 30 秒）
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080/ 2>/dev/null; then
              echo "Firestore Emulator is ready"
              exit 0
            fi
            echo "Waiting for emulator... ($i/30)"
            sleep 1
          done
          echo "ERROR: Firestore Emulator did not start within 30 seconds"
          exit 1

      - name: Run E2E tests
        run: uv run pytest tests/e2e/ -m e2e -v

  firestore-rules:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Start Firestore Emulator
        run: |
          firebase emulators:start --only firestore --project rules-test &
          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:8080/ 2>/dev/null; then
              echo "Firestore Emulator is ready"
              exit 0
            fi
            echo "Waiting for emulator... ($i/30)"
            sleep 1
          done
          echo "ERROR: Firestore Emulator did not start within 30 seconds"
          exit 1

      - name: Run Firestore rules tests
        env:
          FIRESTORE_EMULATOR_HOST: "127.0.0.1:8080"
          PROJECT_ID: "rules-test"
        run: bash scripts/test_firestore_rules.sh
