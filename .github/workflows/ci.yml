name: CI

on:
  pull_request:
    branches: [main]
    paths:
      - "v2/**"
      - "tests/**"
      - "pyproject.toml"
      - "uv.lock"
      - "firestore.rules"
      - "firebase.json"
      - ".github/workflows/ci.yml"

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86 # v5.4.2
        with:
          enable-cache: true

      - uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Ruff lint
        run: uv run ruff check v2/

      - name: Ruff format check
        run: uv run ruff format --check v2/

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86 # v5.4.2
        with:
          enable-cache: true

      - uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run tests
        run: >
          uv run pytest
          tests/unit/
          tests/integration/
          -m "not manual"
          --cov=v2
          --cov-report=term-missing

      - name: Security audit (pip-audit)
        run: uv export --no-hashes | uvx pip-audit -r /dev/stdin

  e2e:
    runs-on: ubuntu-latest
    env:
      FIRESTORE_EMULATOR_HOST: localhost:8080
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86 # v5.4.2
        with:
          enable-cache: true

      - uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --extra dev

      - uses: actions/setup-java@3a4f6e1af504cf6a31855fa899c6aa5355ba6c12 # v4.7.0
        with:
          distribution: "temurin"
          java-version: "21"

      - uses: google-github-actions/setup-gcloud@77e7a554d41e2ee56fc945c52dfd3f33d12def9a # v2.1.4
        with:
          install_components: "cloud-firestore-emulator"

      - name: Start Firestore Emulator
        run: |
          gcloud emulators firestore start --host-port=0.0.0.0:8080 &
          # エミュレーターの起動を待機（最大 30 秒）
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080/ 2>/dev/null; then
              echo "Firestore Emulator is ready"
              exit 0
            fi
            echo "Waiting for emulator... ($i/30)"
            sleep 1
          done
          echo "ERROR: Firestore Emulator did not start within 30 seconds"
          exit 1

      - name: Run E2E tests
        run: uv run pytest tests/e2e/ -m e2e -v

  firestore-rules:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: "22"

      - uses: actions/setup-java@3a4f6e1af504cf6a31855fa899c6aa5355ba6c12 # v4.7.0
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Start Firestore Emulator
        run: |
          firebase emulators:start --only firestore --project rules-test &
          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:8080/ 2>/dev/null; then
              echo "Firestore Emulator is ready"
              exit 0
            fi
            echo "Waiting for emulator... ($i/30)"
            sleep 1
          done
          echo "ERROR: Firestore Emulator did not start within 30 seconds"
          exit 1

      - name: Run Firestore rules tests
        env:
          FIRESTORE_EMULATOR_HOST: "127.0.0.1:8080"
          PROJECT_ID: "rules-test"
        run: bash scripts/test_firestore_rules.sh
